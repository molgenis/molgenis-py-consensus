# VKGL Data release

This guide will explain every step in the VKGL Data release process. Please follow it step by step to guarantee
consistent output for every export.

## Prerequisites

- Add acceptance and production server as host using `mcmd config add host`
- Change host to acceptance
- Paste [these files](https://github.com/molgenis/molgenis-py-consensus/tree/master/mcmd_scripts) in `.mcmd/scripts`
- Set `import_action` in the `settings` section of `mcmd.yaml` to `add`

## Step-by-step guide

1. Ask the ops team to turn on the acceptance server of VKGL and put the newest database dump of the production server
   on it.
2. Login to gearshift with `-A` and make sure ssh key forwarding works. 
3. Create a folder for this release in the tmp directory and change your directory to it.
4. Get the latest tag of [`data-transform-vkgl`](https://github.com/molgenis/data-transform-vkgl/tags)
   (every release, we create a new tag that uses the newest release in the helper scripts):

```commandline
wget https://github.com/molgenis/data-transform-vkgl/archive/refs/tags/data-release-v*insert versionnumber*.zip
unzip data-release-v*insert versionnumber*.zip
```

5. Go to the `data-release-pipeline` folder of the folder you just unzipped and make sure you have excecute permissions
   in the whole directory.
6. Adjust the filenames in `run.sh` to fit the filenames of this export (they are `vkgl_original_filename.tsv`).
7. Create a screen and run `run.sh` like this:

```
screen
./run.sh -l /path/to/lumc.tsv -r /path/to/radboud_mumc.tsv --aws_credentials /path/to/aws/credentials --aws_config  /path/to/aws/config -s /path/to/folder/with/alissa/data
```

Detach the screen using: `Ctrl-a` + `Ctrl-d`

8. Validate the output it generated by running the validation script:

```commandline
ml PythonPlus
python validator/main.py /folder/created/by/run.sh/
```

9. If all checks are successful, continue, else rerun `run.sh` or pinpoint the issue.
10. Change directory back to the directory of your export (`cd ../..`) to download the most recent version of the
    molgenis [EMX downloader](https://github.com/molgenis/molgenis-tools-emx-downloader):

```commandline
wget https://registry.molgenis.org/repository/maven-releases/org/molgenis/downloader/*insert version here*/downloader-*insert version here*.jar
```

11. Download the current consensus and consensus comments:

```commandline
java -jar downloader-*insert version here*.jar -f consensus.zip -u https://yourserver/ -a admin vkgl_consensus
```

12. Unzip the downloaded zip in a newly created folder.

```commandline
unzip consensus.zip
```

13. Now you can either run [this script](https://github.com/molgenis/data-transform-vkgl/pull/50) the following way (
    assuming it's reviewed and merged):
    IMPORTANT: if you're reproducing, make sure you also specify `-m` with the version of `molgenis-py-consensus` that
    was used the last time.

```commandline
python -m venv env
python source env/bin/activate
pip install -e .
python main.py -v /folder/created/by/run.sh/ -l umcg,umcu,nki,amc,vumc,radboud_mumc,lumc,erasmus -i /place/to/store/input/for/molgenis-py-consensus -o /place/to/store/output/for/molgenis-py-consensus -p *comma separated list of yymm dates of all releases* -c unzipped/consensus/folder/vkgl_consensus.tsv -cc unzipped/consensus/folder/vkgl_consensus_comments.tsv
```

Or, do the steps manually:

- Download the latest version (or the one you need) of molgenis-py-consensus
- Create an input and output folder for this tool
- Create a `config.txt` in the `molgenis-py-consensus/config` directory. Example:

```text
labs=umcg,umcu,nki,amc,vumc,radboud_mumc,lumc,erasmus
prefix=vkgl_
consensus=consensus
comments=consensus_comments
previous=1805,1810,1906,1910,1912,2003,2006,2009,2101,2104,2106,2109,2112
history=consensus_history
input=place/to/store/input/for/molgenis-py-consensus/
output=place/to/store/output/for/molgenis-py-consensus/
```

Make sure to update the `previous`, `input` and `output`. The other values will (almost) always stay the same.

- Copy the lab files and with the `vkgl_` prefix (this means for some files you need the `vkgl_vkgl` version) to the
  input dir you specified in the config.
- Rename the files like `vkgl_labname.tsv`.
- Grant permissions to run the consensus scripts:

```commandline
chmod g+x -R /path/to/molgenis-py-consensus
```

- Change dir to molgenis-py-consensus
- Setup and install molgenis-py-consensus

```commandline
python -m venv env
source env/bin/activate
pip install -e .
```

- Run the preprocessor:

```commandline
python preprocessing/PreProcessor.py
```

- Run the history writer:

```commandline
python preprocessing/HistoryWriter.py
```

14. Make sure you first purge your pythonPlus before installing the commander:
    ```commandline
    module purge PythonPlus
    ml Python
    ```
    Then install the commander, following
    [this guide](https://github.com/molgenis/molgenis-tools-commander/wiki/Installation-guide).


15. Configure molgenis commander, if you haven't yet and set host to acceptance server.

``` commandline
mcmd config set host
```

And add the `output` folder of `molgenis-py-consensus` to `dataset_folders` in  `mcmd.yaml`.

16. Import the consensus history on your acceptance

```commandline
mcmd import vkgl_consensus_history.tsv
```

17. Check your molgenis server to make sure the history is uploaded. There should be variants from the previous export
    available in the table. If it looks okay, change the mcmd host to production and run the same command.
18. Download the complete consensus history using the EMX downloader you downloaded earlier:

```commandline
java -jar downloader-*x.y.z*.jar -f consensus_history.zip -u https://yourserver/ -a admin vkgl_consensus_history
```
Place the zip in a directory and unzip it there. 
```
unzip consensus_history.zip
```

19. Place the vkgl_consensus_history.tsv from the zip in your `molgenis-py-consensus` input directory.
20. Load pythonplus again and install the consensus-script. Go to the directory of `molgenis-py-consensus`. If you still
have an environment available, deactivate it (just to be sure, it might say the environment is still running while it's
not). 

```commandline
ml PythonPlus
python -m venv env
source env/bin/activate
pip install -e .
```

21. Make sure you still have a screen running (`screen -ls`). Then run the consensus script:

```commandline
python consensus
```

22. The script takes over a day to run, so detach your screen to make sure your internet connection won't mess up
    the script run, by pressing `ctrl+a d`.

23. Now you have plenty of time to create the ClinVar files (*N.B. DON'T SUBMIT THE FILES UTIL ACCEPTED in step 36*).
    To do this, get the most recent version (or another version, if you wish) of
    [vkgl-clinvar](https://github.com/molgenis/vkgl-clinvar).

```
wget https://github.com/molgenis/vkgl-clinvar/releases/download/v*x.y.z*/vkgl-clinvar-writer.jar
```

24. Go to clinvar, select `Submit` in the dropdown and click `Submission portal` (this way you will be redirected to the
    correct overview). Download `SUB*submission id*_(100)_submitter_report_B.txt` of the previous ClinVar submits for
    all labs.

25. Create an output folder for your clinvar submit files.
26. Run the script:

``` commandline
java -jar vkgl-clinvar-writer.jar -i /output/of/runs.sh/consensus/consensus.tsv -m /path/to/files/from/previous/clinvar/submit/*export name*_UNCHANGED_identifiers.tsv -c amc=/path/to/SUB*submission id*_(100)_submitter_report_B.txt,lumc=/path/to/SUB*submission id*_(100)_submitter_report_B.txt,nki=/path/to/SUB*submission id*_(100)_submitter_report_B.txt,umcg=/path/to/SUB*submission id*_(100)_submitter_report_B.txt,radboud_mumc=/path/to/SUB*submission id*_(100)_submitter_report_B.txt,umc_utrecht=/path/to/SUB*submission id*_(100)_submitter_report_B.txt,vumc=/path/to/SUB*submission id*_(100)_submitter_report_B.txt,erasmus_mc=/path/to/SUB*submission id*_(100)_submitter_report_B.txt -o /output/folder/for/clinvar/data -r mon_yyyy -f
```

27. Check if your consensus script is still running:

```commandline
screen -r
```

If everything is okay, press `ctrl+a d` again. Now all we need to do is wait until the script is done. After it's done,
type `deactivate` to deactivate the virtual environment.

28. Make sure you purge the PythonPlus module again and load Python to run the commander.

29. Change the mcmd host to the acceptance server again. Test if the output works by uploading it to the test server:

```commandline
mcmd run vkgl_cleanup_consensus
mcmd run vkgl_cleanup_labs
mcmd delete --data vkgl_comments -f
mcmd import vkgl_comments.tsv
mcmd run vkgl_import_labs
mcmd import vkgl_consensus_comments.tsv
mcmd import vkgl_consensus.tsv
mcmd delete --data vkgl_public_consensus -f
mcmd import vkgl_public_consensus.tsv
```

If you get a `504` error throughout this process. You can start a mcmd script from a certain line using
the `--from-line` command. Keep retrying until you don't get the `504` anymore. Trust me, it will work.

Check if everything looks fine on the acceptance server before continuing. 

30. Time to upload production. Set a message on the homepage by editing the `home` row in `sys_StaticContent` (don't do
    it via the home page, it will mess up everything!):

```html
<div class="alert alert-warning" role="alert">
    We are currently working on the new VKGL data release, this means some data might be missing or incorrect. As soon
    as
    this message is no longer on our homepage, the release is updated and save to use. We thank you for your
    understanding
    and patience.
</div>
```

31. Set the mcmd host to production and run the following commands on production:

```commandline
mcmd run vkgl_cleanup_consensus
mcmd run vkgl_cleanup_labs
mcmd delete --data vkgl_comments -f
mcmd import vkgl_comments.csv
mcmd run vkgl_import_labs
mcmd import vkgl_consensus_comments.csv
mcmd import vkgl_consensus.csv
mcmd delete --data vkgl_public_consensus -f
mcmd import vkgl_public_consensus.csv
```

32. Update the counts page by editing the `news` row in the `sys_StaticContent` table and paste the `counts.html` that
    was produced by `molgenis-py-consensus`.

33. Upload the public consensus to the downloadserver and update the downloads page in the static content table.
34. Update the name of the export in the menu.
35. Update the name of the export on the homepage and remove the message.
36. Email the contact persons for acceptance testing.
37. Once accepted, do the ClinVar submissions. [Need help?](https://github.com/molgenis/vkgl-clinvar)
38. Copy the errorfiles in the `transformed` folder and the raw files in the `preprocessed` of `run.sh` to your local
    computer. 
39. Send the email notifying everyone that the VKGL release is done and the clinvar submission is in progress.
40. Send the error files to all labs via email.
41. Copy the vkgl_consensus.tsv from the `molgenis-py-consensus` output folder to your local computer.
42. Open filezilla and configure connection with the 3 accounts. 
    [Need help?](http://docs.gcc.rug.nl/nibbler/dedicated-dt-server-external-collaborators)
43. First connect with radboud. Add a folder to the current export folder called `consensus` and add the consensus file
    to it. Add a new folder for the next export in the home directory. 
44. Disconnect and connect with lumc. Add a folder called `raw` to the folder of the current export and add the raw
    files (excluding the umcg artefacts and lumc data) from the preprocessed folder you downloaded earlier. Add a new 
    folder for the next export in the home directory.
45. Disconnect and connect with alissa. Add a new folder for the next export in the home directory. Disconnect.
46. Contact lumc and radboud about the updated data. 
47. Go to `data-transform-vkgl/dir/data-release-pipeline/utils` and generate the gene id's for the consensus file:

```
./vkgl_consensus_add_gene_id.sh -i /path/to/molgenis/output/vkgl_consensus.tsv -o /path/to/vipdir/molgenis-consensus-output/vkgl_consensus.tsv -g ../datetimeoftransformeddata/downloads/hgnc_genes_20210920.tsv
./vkgl_consensus_add_gene_id.sh -i /path/to/molgenis/output/vkgl_public_consensus.tsv -o /path/to/vipdir/molgenis-consensus-output/vkgl_public_consensus.tsv -g ../datetimeoftransformeddata/downloads/hgnc_genes_20210920.tsv
```

48. Get the vcf-tsv converter in the utils folder of data-transform:

```commandline
wget https://github.com/molgenis/tsv-vcf-converter/releases/download/vx.y.z/tsv-vcf-converter.jar
```

49. Do the liftover for the vip data:

```
./liftover_vkgl_consensus.sh /path/to/vipdir/vkgl_public_consensus.tsv /path/to/vipdir/vkgl_public_consensus_hg38.tsv
./liftover_vkgl_consensus.sh /path/to/vipdir/vkgl_consensus.tsv /path/to/vipdir/vkgl_consensus_hg38.tsv
```

50. Deploy data (with _monyyyy as postfix) of `vip` directory on the clusters:

    **Fender**

    ***Public only**, GRCh37 + GRCh38*
    ```
    /apps/data/VKGL/GRCh37/
    /apps/data/VKGL/GRCh38/
    ```
    **Gearshift**

    *public + private + artefacts, GRCh37 + GRCh38*
    ```
    /apps/data/VKGL/GRCh37/
    /apps/data/VKGL/GRCh38/
    ```
    **zf-ds**

    *public + private + artefacts, **GRCh37 only***
    ```
    /apps/data/VKGL/GRCh37/
    ```
51. Persist data on the`gearshift` cluster. Create a new folder with a name like `yyyymm` in
    the `/groups/umcg-gcc/prm03/projects/VKGL/` folder.
52. In this directory make the following folders:

- clinvar
- molgenis
- raw
- data-transform
- vip
53. Fill the raw folder by copying all raw data you got from Radboud/MUMC, LUMC and all Alissa data.
54. Fill the data-transform folder by copying all data from the data-transform-vkgl/data-release-pipeline/dateofyourdata
    using cp -r to it
55. In the molgenis folder create an input and an output folder.
56. In the input directory place all content of the input folder of molgenis-py-consensus.
57. In the output directory place all content of the output folder of molgenis-py-consensus.
58. Fill the `vip` folder with all data in the `vip` folder on tmp.
59. Go to the ClinVar folder and make a `generated` and `reports` folder in there.
60. Copy all content of the folder with the output of the vkgl-clinvar-writer to the generated folder.
61. When ClinVar is done evaluating, go to the submission portal and download all reports and place them in the reports
    folder. Prefix them with the correct lab name.
62. Create a `versions.txt` in `/groups/umcg-gcc/prm03/projects/VKGL/yyyymm/` with the following content:
    ```text
    DATA:
    Alissa: yyyymmdd
    Radboud/MUMC: yyyy-mm-dd
    LUMC: yyyy-mm-dd
    HGNC genes file: yyyymmdd

    Scripts:
    data-transform-vkgl and run.sh: data-release-vx.y.z
    tsv-vcf-converter: vx.y.z
    vkgl-clinvar: vx.y.z
    molgenis-py-consensus: x.y.z
    molgenis-tools-emx-downloader: x.y.z
    molgenis-tools-commander: vx.y.z
    ```
    Fill in the versions used for this export.